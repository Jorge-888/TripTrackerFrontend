<div class="viajes-container">
    <p-card styleClass="viajes-card"
        [style]="{ 'border': '1px solid #e9e2db', 'border-radius': '12px', 'background': 'linear-gradient(to bottom, #ffffff 0%, #fafafa 100%)' }">

        <ng-template pTemplate="header">
            <div style="padding:1.5rem 1.5rem 1rem;display:flex;justify-content:space-between;align-items:center;">
                <div>
                    <div style="display:flex;align-items:center;gap:0.75rem;margin-bottom:0.5rem;">
                        <i class="pi pi-map" style="font-size:1.5rem;color:#875D4A;"></i>
                        <h3 style="margin:0;color:#111;font-size:1.5rem;font-weight:600;">Viajes</h3>
                    </div>
                </div>
                <div *ngIf="!showCreateForm && !showEditForm && !showDetailsView">
                    <p-button label="Nuevo Viaje" icon="pi pi-plus" [rounded]="true" (onClick)="toggleCreateForm()"
                        styleClass="p-button-raised" [style]="{ 
              'background': '#875D4A', 
              'border-color': '#875D4A',
              'box-shadow': '0 4px 6px -1px rgba(135, 93, 74, 0.2), 0 2px 4px -1px rgba(135, 93, 74, 0.1)'
            }">
                    </p-button>
                </div>
            </div>
        </ng-template>

        <ng-template pTemplate="content">
            <div *ngIf="showCreateForm" style="margin-bottom:1.5rem;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
                    <h3 style="margin:0;color:#111;font-size:1.25rem;font-weight:600;">
                        <i class="pi pi-plus-circle" style="color:#875D4A;margin-right:0.5rem;"></i>
                        Nuevo Viaje
                    </h3>
                    <p-button label="Regresar" icon="pi pi-arrow-left" [outlined]="true" [rounded]="true"
                        (onClick)="onCancelCreate()" severity="secondary">
                    </p-button>
                </div>
                <app-create (created)="onViajeCreated($event)" (cancel)="onCancelCreate()"></app-create>
            </div>

            <div *ngIf="showEditForm && selectedViaje">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
                    <h3 style="margin:0;color:#111;font-size:1.25rem;font-weight:600;">
                        <i class="pi pi-pencil" style="color:#875D4A;margin-right:0.5rem;"></i>
                        Editando Viaje
                    </h3>
                    <p-button label="Regresar" icon="pi pi-arrow-left" [outlined]="true" [rounded]="true"
                        (onClick)="onEditCancelled()" severity="secondary">
                    </p-button>
                </div>
                <app-edit [viajeToEdit]="selectedViaje" (updated)="onViajeUpdated($event)"
                    (cancel)="onEditCancelled()"></app-edit>
            </div>

            <div *ngIf="showDetailsView && selectedViaje">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
                    <h3 style="margin:0;color:#111;font-size:1.25rem;font-weight:600;">
                        <i class="pi pi-eye" style="color:#875D4A;margin-right:0.5rem;"></i>
                        Detalles del Viaje
                    </h3>
                    <p-button label="Regresar" icon="pi pi-arrow-left" [outlined]="true" [rounded]="true"
                        (onClick)="onDetailsClose()" severity="secondary">
                    </p-button>
                </div>
                <app-details [viaje]="selectedViaje" (close)="onDetailsClose()"></app-details>
            </div>

            <div *ngIf="!showCreateForm && !showEditForm && !showDetailsView">
                <div *ngIf="loading" class="skeleton-container">
                    <p-skeleton height="3rem" styleClass="mb-3"></p-skeleton>
                    <p-skeleton height="3rem" styleClass="mb-3"></p-skeleton>
                    <p-skeleton height="3rem" styleClass="mb-3"></p-skeleton>
                </div>

                <div *ngIf="!loading" style="margin-bottom:1rem;display:flex;gap:1rem;align-items:end;">
                    <div style="flex:1;">
                        <label for="globalFilter"
                            style="display:block;margin-bottom:0.5rem;color:#334155;font-weight:500;font-size:0.9rem;">
                            Buscar
                        </label>
                        <input pInputText type="text" [(ngModel)]="globalFilterValue" (input)="onGlobalFilter($event)"
                            placeholder="Buscar en todos los campos..."
                            style="width:100%;padding:0.75rem;border:1px solid #e2e8f0;border-radius:6px;" />
                    </div>
                    <div style="width:250px;">
                        <label for="dateFilter"
                            style="display:block;margin-bottom:0.5rem;color:#334155;font-weight:500;font-size:0.9rem;">
                            Filtrar por Fecha
                        </label>
                        <div style="display:flex;gap:0.5rem;">
                            <p-datepicker [(ngModel)]="dateFilterValue" (onSelect)="onDateFilter()" [showIcon]="true"
                                dateFormat="dd/mm/yy" placeholder="Selecciona fecha" [style]="{ 'width': '100%' }">
                            </p-datepicker>
                            <p-button *ngIf="dateFilterValue" icon="pi pi-times" [rounded]="true" [text]="true"
                                (onClick)="clearDateFilter()" severity="secondary" [style]="{ 'color': '#64748b' }">
                            </p-button>
                        </div>
                    </div>
                </div>

                <p-table #dt *ngIf="!loading" [value]="viajes" [tableStyle]="{ 'min-width': '60rem' }"
                    styleClass="p-datatable-sm" [paginator]="true" [rows]="10" [rowsPerPageOptions]="[5, 10, 20]"
                    [showCurrentPageReport]="true"
                    [globalFilterFields]="['viaj_Fecha', 'sucu_Descripcion', 'trpo_Nombres', 'trpo_Apellidos', 'viaj_TarifaKM', 'viaj_TarifaTotal', 'trpo_Placa', 'trpo_Vehiculo']"
                    currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} viajes">

                    <ng-template pTemplate="header">
                        <tr>
                            <th style="width:5%;color:#111;font-weight:600;text-align:center;">Acciones</th>
                            <th pSortableColumn="viaj_Fecha" style="width:12%;color:#111;font-weight:600;">
                                Fecha <p-sortIcon field="viaj_Fecha"></p-sortIcon>
                            </th>
                            <th pSortableColumn="sucu_Descripcion" style="width:18%;color:#111;font-weight:600;">
                                Sucursal <p-sortIcon field="sucu_Descripcion"></p-sortIcon>
                            </th>
                            <th pSortableColumn="trpo_Nombres" style="width:20%;color:#111;font-weight:600;">
                                Transportista <p-sortIcon field="trpo_Nombres"></p-sortIcon>
                            </th>
                            <th pSortableColumn="viaj_TarifaKM"
                                style="width:10%;color:#111;font-weight:600;text-align:center;">
                                Tarifa KM <p-sortIcon field="viaj_TarifaKM"></p-sortIcon>
                            </th>
                            <th pSortableColumn="viaj_TarifaTotal"
                                style="width:12%;color:#111;font-weight:600;text-align:center;">
                                Tarifa Total <p-sortIcon field="viaj_TarifaTotal"></p-sortIcon>
                            </th>
                            <th pSortableColumn="trpo_Placa" style="width:10%;color:#111;font-weight:600;">
                                Placa <p-sortIcon field="trpo_Placa"></p-sortIcon>
                            </th>
                            <th pSortableColumn="trpo_Vehiculo" style="width:13%;color:#111;font-weight:600;">
                                Vehículo <p-sortIcon field="trpo_Vehiculo"></p-sortIcon>
                            </th>
                        </tr>
                    </ng-template>

                    <ng-template pTemplate="body" let-viaje let-i="rowIndex">
                        <tr class="hover-row">
                            <td style="text-align:center;">
                                <p-button icon="pi pi-ellipsis-v" [rounded]="true" [text]="true"
                                    (onClick)="onMenuClick($event, viaje)" [style]="{ 'color': '#111' }">
                                </p-button>
                            </td>

                            <td style="font-weight:500;color:#1e293b;">
                                {{ formatFecha(viaje.viaj_Fecha) }}
                            </td>

                            <td style="font-weight:500;color:#1e293b;">
                                {{ viaje.sucu_Descripcion }}
                            </td>

                            <td style="color:#64748b;">
                                {{ getTransportistaNombre(viaje) }}
                            </td>

                            <td style="text-align:center;color:#64748b;">
                                L {{ viaje.viaj_TarifaKM | number:'1.2-2' }}
                            </td>

                            <td style="text-align:center;font-weight:600;color:#875D4A;">
                                L {{ viaje.viaj_TarifaTotal | number:'1.2-2' }}
                            </td>

                            <td style="color:#64748b;">
                                {{ viaje.trpo_Placa }}
                            </td>

                            <td style="color:#64748b;">
                                {{ viaje.trpo_Vehiculo }}
                            </td>
                        </tr>
                    </ng-template>

                    <ng-template pTemplate="emptymessage">
                        <tr>
                            <td colspan="8" style="text-align:center;padding:2rem;color:#64748b;">
                                <i class="pi pi-inbox"
                                    style="font-size:3rem;color:#cbd5e1;margin-bottom:1rem;display:block;"></i>
                                No hay viajes registrados
                            </td>
                        </tr>
                    </ng-template>
                </p-table>

                <p-menu #menu [model]="menuItems" [popup]="true"></p-menu>
            </div>
        </ng-template>
    </p-card>
</div>

<style>
    .viajes-container {
        padding: 1rem;
    }

    ::ng-deep .hover-row:hover {
        background-color: rgba(135, 93, 74, 0.05) !important;
        transition: background-color 0.2s ease;
    }

    ::ng-deep .p-datatable .p-datatable-thead>tr>th {
        background: #f8fafc;
        border-bottom: 2px solid #875D4A;
        padding: 1rem;
    }

    ::ng-deep .p-datatable .p-datatable-tbody>tr>td {
        padding: 0.875rem 1rem;
        border-bottom: 1px solid #e2e8f0;
    }

    ::ng-deep .p-paginator {
        background: #f8fafc;
        border-top: 1px solid #e2e8f0;
        padding: 1rem;
    }

    ::ng-deep .p-paginator .p-paginator-current {
        color: #64748b;
    }

    ::ng-deep .p-paginator .p-paginator-pages .p-paginator-page.p-highlight {
        background: #875D4A;
        border-color: #875D4A;
        color: #fff;
    }

    .skeleton-container {
        padding: 1rem;
    }

    .dropdown-container {
        position: relative;
        display: inline-block;
    }

    .action-button {
        background: none;
        border: none;
        cursor: pointer;
        padding: 0.5rem;
        border-radius: 50%;
        transition: background-color 0.2s;
        color: #111;
        font-size: 1.2rem;
    }

    .action-button:hover {
        background-color: rgba(135, 93, 74, 0.1);
    }

    .dropdown-menu {
        position: absolute;
        right: 0;
        top: 100%;
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        min-width: 160px;
        z-index: 1000;
        margin-top: 0.25rem;
    }

    .dropdown-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        width: 100%;
        padding: 0.75rem 1rem;
        border: none;
        background: none;
        cursor: pointer;
        text-align: left;
        transition: background-color 0.2s;
        color: #334155;
        font-size: 0.95rem;
    }

    .dropdown-item:first-child {
        border-radius: 8px 8px 0 0;
    }

    .dropdown-item:last-child {
        border-radius: 0 0 8px 8px;
    }

    .dropdown-item:hover {
        background-color: rgba(135, 93, 74, 0.1);
    }

    .dropdown-item i {
        color: #875D4A;
        font-size: 1rem;
    }

    @media (max-width: 768px) {
        .viajes-container {
            padding: 0.5rem;
        }
    }
</style>

<!-- Delete Confirmation Modal -->
<p-dialog [(visible)]="showDeleteModal" [modal]="true" [closable]="false" [style]="{ width: '450px' }"
    [draggable]="false">
    <ng-template pTemplate="header">
        <div style="display:flex;align-items:center;gap:0.75rem;">
            <i class="pi pi-exclamation-triangle" style="font-size:1.5rem;color:#ef4444;"></i>
            <span style="font-size:1.25rem;font-weight:600;">Confirmar Eliminación</span>
        </div>
    </ng-template>

    <div style="padding:1rem 0;">
        <p style="margin:0;font-size:1rem;color:#334155;line-height:1.6;">
            ¿Está seguro que desea eliminar el viaje del
            <strong>{{ selectedViaje ? formatFecha(selectedViaje.viaj_Fecha) : '' }}</strong>
            en la sucursal
            <strong>{{ selectedViaje?.sucu_Descripcion }}</strong>?
        </p>
        <p style="margin:1rem 0 0;font-size:0.9rem;color:#ef4444;font-weight:500;">
            <i class="pi pi-info-circle"></i>
            Esta acción no se puede deshacer.
        </p>
    </div>

    <ng-template pTemplate="footer">
        <div style="display:flex;gap:0.75rem;justify-content:flex-end;">
            <p-button label="Cancelar" icon="pi pi-times" (onClick)="cancelDelete()" [outlined]="true"
                severity="secondary">
            </p-button>
            <p-button label="Eliminar" icon="pi pi-trash" (onClick)="confirmDelete()" severity="danger"
                [style]="{ 'background': '#ef4444', 'border-color': '#ef4444' }">
            </p-button>
        </div>
    </ng-template>
</p-dialog>